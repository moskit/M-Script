#!/bin/bash

# Copyright (C) 2008-2011 Igor Simonov (me@igorsimonov.com)
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

declare -i depth
depth=0
declare -i i
i=0
declare -a branch

addnode() {
  nd=${1% *}
  [[ "$nd" =~ ^\? ]] && return 0

#  [ -z "$filename" ] && filename=${inputfile%.*}.$nd.txt && depth+=1 && return 0
#  [[ $lf -eq 0 ]] && lname=$nd && lf=1 && depth+=1 && return 0
  if [[ "$nd" =~ ^\/ ]] ; then
    unset cont
    for ((n=0; n<${#branch[*]}; n++)) ; do

      if [ "X${branch[$n]}" == "X${nd#/}" ] ; then
        
        ndcont=${branch[$n+1]}
        echo "=== $n: ${branch[$n]} == ${nd#/} : ${branch[$n+1]}"
        break
      fi
    done
    i+=-1
    if [ -n "$ndcont" ] ; then
      i+=-1
    else
#      for ((n=0; n<${#branch[*]}; n++)) ; do tree="${tree}::${branch[$n]}" ; done
      for ((n=0; n<${#branch[*]}; n++)) ; do echo "${branch[$n]}::" ; done
    fi
  else
    unset ndcont
    [ -n "$cont" ] || cont=$nd
    i+=1
    branch[$i]=$nd
    if [[ $i -gt $depth ]] ; then depth+=1 ; fi
  
  fi
  echo "$i|$depth|$nd|$cont|$ndcont|$tree"
}

# Getting the nodes

inputfile=$1
( IFS='<>' ; for LINE in `cat $inputfile` ; do echo "${LINE}" ; done ) | while read node ; do ([ "$node" != "" ] && [ "$node" != "|" ]) && addnode $node; done

unset branch ndcont cont i depth tree LINE node inputfile

