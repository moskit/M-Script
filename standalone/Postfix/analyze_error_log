#!/bin/bash
rpath=$(readlink -f "$BASH_SOURCE")
rcommand=${rpath##*/}
rpath=${rpath%/*}
#*/
[ -z "$M_ROOT" ] && M_ROOT=$(readlink -f "$rpath/../../")
source "$rpath/../../lib/functions.sh"
KEEP_LOG=false
RECIPIENT_STATS=false

source "$rpath/postfix.conf"
now=`date +"%b %d %H:%M:%S"`

IFS='
'
if [ -e "$rpath/data/error.log" ]; then
  conf=`cat "$rpath/error_patterns.conf" | grep -vE "^$|^#|^[[:space:]]#"`
  for rule in `echo "$conf" | cut -sd'|' -f1 | sort | uniq | grep -v ^$` ; do
    match_cond=`echo "$conf" | grep "^$rule|" | cut -sd'|' -f2,3,4 | sort | uniq | grep -v ^$`
    for status_errnum in `echo "$match_cond" | cut -sd'|' -f1,2 | sort | uniq` ; do
    
      errnum=`echo "$status_errnum" | cut -sd'|' -f2`
      status=`echo "$status_errnum" | cut -sd'|' -f1`
      pattern=`echo "$match_cond" | grep "^$status_errnum|" | grep -v '|%.*%$' | cut -d'|' -f3 | tr '\n' '|'`
      pattern=${pattern%|}
      exclpattern=`echo "$match_cond" | grep "^$status_errnum|" | grep '|%.*%$' | cut -d'|' -f3 | tr '\n' '|' | tr -d '%'`
      exclpattern=${exclpattern%|}
      
      if [ -n "$pattern" ]; then
        if [ -n "$exclpattern" ]; then
          if [ -n "$errnum" ]; then
            match=`grep "|$status|" "$rpath/data/error.log" | cut -d'|' -f1,3 | grep -v '^$' | grep " $errnum " | grep -viE "$exclpattern" | grep -iE "$pattern" | cut -d'|' -f1,2 | sort | uniq`
          else
            match=`grep "|$status|" "$rpath/data/error.log" | cut -d'|' -f1,3 | grep -v '^$' | grep -viE "$exclpattern" | grep -iE "$pattern" | cut -d'|' -f1,2 | sort | uniq`
          fi
        else
          if [ -n "$errnum" ]; then
            match=`grep "|$status|" "$rpath/data/error.log" | cut -d'|' -f1,3 | grep -v '^$' | grep " $errnum " | grep -iE "$pattern" | cut -d'|' -f1,2 | sort | uniq`
          else
            match=`grep "|$status|" "$rpath/data/error.log" | cut -d'|' -f1,3 | grep -v '^$' | grep -iE "$pattern" | cut -d'|' -f1,2 | sort | uniq`
          fi
        fi
      fi
      matched=`echo -n "$match" | wc -l`
      if [ $matched -gt 0 ]; then
        echo "$match" >> "$rpath/data/${rule}.log"
        echo "<**> Pattern match for rule '$rule':  $matched times"
        if $RECIPIENT_STATS ; then
          for line in `echo "$match"`; do
            to=`echo "$line" | cut -sd'|' -f1`
            sdate=`echo "$line" | cut -sd'|' -f4`
            [ -z "$sdate" ] && sdate=$now
          dbquery "$rpath/data/recipients.db" "UPDATE recipients SET custom_date='$sdate', custom='$rule' WHERE email='$to'"
        fi
      else
        echo "<OK> No pattern match for rule '$rule'"
      fi
      
    done
  done
  $KEEP_LOG && cat "$rpath/data/error.log" 2>/dev/null >> "$rpath/data/error.log.save"
  rm "$rpath/data/error.log"
else
  echo "<OK> Error log is empty"
fi

IFS=$IFSORIG


